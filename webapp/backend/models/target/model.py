from functools import cached_property
from django.db import models
from django.contrib import admin

from django_object_actions import DjangoObjectActions
from django.db.models.signals import post_save



from .ports import PortsManager

from .mixins.tech import TechFingerprints


class Target(TechFingerprints, models.Model):

    name = "Target"

    host = models.CharField(max_length=255, unique=True)

    added_timestamp = models.DateTimeField(auto_now_add=True)

    last_scan_stamp = models.DateTimeField(auto_now_add=True)


    def __init__(
        self,
        audit_on_add = True
    ) -> None:
        super().__init__()

    def __str__(self) -> str: 
        return f'{self.host}'

    


    def enqueue_scan_ports(self):
        from lib.modules.scanners.ports import PortScanner
        result = PortScanner.apply(self.host)
        for port in result['ports']:
            print("Found port open", port)

    

    
@admin.register(Target)
class TargetAdmin(DjangoObjectActions, admin.ModelAdmin):
    list_display = [
        'host',
        'open_ports'
    ]





    def scan_ports(self,request,obj):
        pass


    def open_ports(self,obj):
        return obj.open_ports

    scan_ports.label = "Scan ports"
    scan_ports.short_description = "Scan ports fast"
    
    change_actions = ('scan_ports', )

    actions = ('scan_ports', )

    tools_view_name = "AAA"
