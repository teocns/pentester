
from celery import Celery
from config import RABBITMQ_HOST, REDIS_HOST

from lib.modules.mixins.worker import WorkerMixin



def create_app(worker_name) -> Celery:
    app = Celery(
        worker_name,
        broker="amqp://guest:guest@%s//" % RABBITMQ_HOST,
        backend="redis://%s/0" % REDIS_HOST,
    )

    #app.autodiscover_tasks(["lib.modules"], related_name="*")
    import inspect
    import lib.modules


    # Register all worker modules modules
    for name, obj in inspect.getmembers(lib.modules):
        if inspect.isclass(obj) and issubclass(obj,WorkerMixin):
            app.register_task(obj)
    
    app.autodiscover_tasks()

    app.conf.update(
        task_serializer="pickle", result_serializer="pickle", accept_content=[
            "application/x-python-serialize",
            "application/json",
            "application/text"
        ]
    )

    return app
