import unittest
from lib.utils.threading.thread_with_result import ThreadWithResult
from lib.www.patch import UrllibPatchContextManager
import urllib.request
import threading 
import time

class TestPatcher(unittest.TestCase):

    def test_context_manager(self):
        def _test(i, sleep):
            with UrllibPatchContextManager({'urlopen': lambda *args, **kwargs: i}):
                time.sleep(sleep)
                return urllib.request.urlopen('http://www.google.com')


        threads = []
        for i in range(3):
            t = ThreadWithResult(target=_test, args=[i, 3-i])
            t.i = i
            threads.append(t)
            t.start()
        
        for t in threads:
            t.join()
            assert t.result == t.i

    # def test_opener():
    #     opener = urllib.request.build_opener()
